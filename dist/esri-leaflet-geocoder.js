/*! esri-leaflet-geocoder - v0.0.1 - 2013-10-10
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(a){function b(a){var b="?";for(var c in a)if(a.hasOwnProperty(c)){var d=c,e=a[c];b+=encodeURIComponent(d),b+="=",b+=encodeURIComponent(e),b+="&"}return b.substring(0,b.length-1)}function c(b){var c=new a.LatLng(b.ymin,b.xmin),d=new a.LatLng(b.ymax,b.xmax);return new a.LatLngBounds(c,d)}var d="https:"===window.location.protocol?"https:":"http:",e=a.Class.extend({options:{url:d+"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/",outFields:"Subregion, Region, PlaceName, Match_addr, Country, Addr_type, City, Type"},initialize:function(b){a.Util.setOptions(this,b)},request:function(a,c,d){var f="c"+(1e9*Math.random()).toString(36).replace(".","_");c.f="json",c.callback="GeocodeService._callback."+f;var g=document.createElement("script");g.type="text/javascript",g.src=a+b(c),g.id=f,e._callback[f]=function(a){d(a),document.body.removeChild(g),delete e._callback[f]},document.body.appendChild(g)},geocode:function(b,c,d){var e={outFields:this.options.outFields},f=a.extend(e,c);f.text=b,this.request(this.options.url+"find",f,d)},suggest:function(a,b,c){var d=b||{};d.text=a,this.request(this.options.url+"suggest",d,c)}});e._callback={},a.GeocoderControl=a.Control.extend({includes:a.Mixin.Events,options:{position:"topleft",zoomToResult:!0,useMapBounds:11,collapseAfterResult:!0,expanded:!1,contianerClass:"geocoder-control",inputClass:"geocoder-control-input leaflet-bar",suggestionsWrapperClass:"geocoder-control-suggestions leaflet-bar",selectedSuggestionClass:"geocoser-control-selected",expandedClass:"geocoder-control-expanded"},initialize:function(b){a.Util.setOptions(this,b),this._service=new e},_geocode:function(b,d){var e={magicKey:d};a.DomUtil.addClass(this._input,"loading"),this._service.geocode(b,e,a.Util.bind(function(d){a.DomUtil.removeClass(this._input,"loading");var e=d.locations[0],f=e.feature.attributes,g=c(e.extent);this.options.zoomToResult&&this._map.fitBounds(g),this.fire("result",{text:b,bounds:g,latlng:new a.LatLng(e.feature.geometry.y,e.feature.geometry.x),type:f.Type,name:f.PlaceName,match:f.Addr_type,country:f.Country,region:f.Region,subregion:f.Subregion,city:f.City,address:f.Match_addr}),this.clear()},this))},_suggest:function(b){a.DomUtil.addClass(this._input,"loading");var c={};if(this.options.useMapBounds===!0||this._map.getZoom()>this.options.useMapBounds){var d=this._map.getBounds(),e=d.getCenter(),f=d.getNorthWest();c.location=e.lng+","+e.lat,c.distance=Math.min(Math.max(e.distanceTo(f),2e3),5e4)}this._service.suggest(b,c,a.Util.bind(function(b){if(this._suggestions.innerHTML="",b.suggestions)for(var c=0;c<b.suggestions.length;c++){var d=a.DomUtil.create("li","geocoder-control-suggestion",this._suggestions);d.innerHTML=b.suggestions[c].text,d["data-magic-key"]=b.suggestions[c].magicKey}a.DomUtil.removeClass(this._input,"loading")},this))},clear:function(){this._suggestions.innerHTML="",this._input.value="",this.options.collapseAfterResult&&a.DomUtil.removeClass(this._container,this.options.expandedClass),this._input.blur()},onAdd:function(b){return this._map=b,this._container=a.DomUtil.create("div",this.options.contianerClass+(this.options.expanded?" "+this.options.expandedClass:"")),this._input=a.DomUtil.create("input",this.options.inputClass,this._container),this._suggestions=a.DomUtil.create("ul",this.options.suggestionsWrapperClass,this._container),a.DomEvent.addListener(this._container,"click",function(){a.DomUtil.addClass(this._container,this.options.expandedClass)},this),a.DomEvent.addListener(this._suggestions,"mousedown",function(a){this._geocode(a.target.innerHTML,a.target["data-magic-key"]),this.clear()},this),a.DomEvent.addListener(this._input,"blur",function(){this.clear()},this),a.DomEvent.addListener(this._input,"keydown",function(b){var c=this._suggestions.getElementsByClassName(this.options.selectedSuggestionClass)[0];switch(b.keyCode){case 13:c=c||this._suggestions.childNodes[0].innerHTML,this._geocode(c.innerHTML,c["data-magic-key"]),this.clear(),a.DomEvent.preventDefault(b);break;case 38:c&&a.DomUtil.removeClass(c,this.options.selectedSuggestionClass),c&&c.previousSibling?a.DomUtil.addClass(c.previousSibling,this.options.selectedSuggestionClass):a.DomUtil.addClass(this._suggestions.childNodes[this._suggestions.childNodes.length-1],this.options.selectedSuggestionClass),a.DomEvent.preventDefault(b);break;case 40:c&&a.DomUtil.removeClass(c,this.options.selectedSuggestionClass),c&&c.nextSibling?a.DomUtil.addClass(c.nextSibling,this.options.selectedSuggestionClass):a.DomUtil.addClass(this._suggestions.childNodes[0],this.options.selectedSuggestionClass),a.DomEvent.preventDefault(b)}},this),a.DomEvent.addListener(this._input,"keyup",function(a){13!==a.keyCode&&38!==a.keyCode&&40!==a.keyCode&&this._suggest(a.target.value)},this),this._container}})}(L);